<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.2.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/white_flower1.jpg">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/white_flower1.jpg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/white_flower1.jpg">
  <link rel="mask-icon" href="/images/white_flower1.jpg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.lug.ustc.edu.cn/css?family=Fira+Code:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"lyk-love.cn","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.15.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":"flat"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":"enable","trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Outline：  Linux文件操作api">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux Programming">
<meta property="og:url" content="http://lyk-love.cn/2022/05/05/Linux-Programming/index.html">
<meta property="og:site_name" content="LYK-love">
<meta property="og:description" content="Outline：  Linux文件操作api">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-05-05T03:43:30.000Z">
<meta property="article:modified_time" content="2023-02-08T07:44:07.947Z">
<meta property="article:author" content="LYK-love">
<meta property="article:tag" content="Linux">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://lyk-love.cn/2022/05/05/Linux-Programming/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://lyk-love.cn/2022/05/05/Linux-Programming/","path":"2022/05/05/Linux-Programming/","title":"Linux Programming"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Linux Programming | LYK-love</title>
  

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?07a572cad308bc3b22d354fca4209fed"></script>






<link href="https://fonts.googleapis.com/css?family=Noto+Serif+SC|Roboto&display=swap" rel="stylesheet">
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="LYK-love" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">LYK-love</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Linux-File"><span class="nav-text">Linux File</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#File-types"><span class="nav-text">File types</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#File-Structure"><span class="nav-text">File  Structure</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FIle-Descripter"><span class="nav-text">FIle Descripter</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Basic-I-O-System-Calls"><span class="nav-text">Basic I&#x2F;O System Calls</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#File-descriptor"><span class="nav-text">File descriptor</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#File-Name-Suffix"><span class="nav-text">File Name Suffix</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#File-Permission"><span class="nav-text">File Permission</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#umask"><span class="nav-text">umask</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#access-function"><span class="nav-text">access function</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#chmod-fchmod-functions"><span class="nav-text">chmod&#x2F;fchmod functions</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#File-Attribute"><span class="nav-text">File Attribute</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Linux-Signal"><span class="nav-text">Linux Signal</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#I-O%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8"><span class="nav-text">I&#x2F;O系统调用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#open-creat-Function"><span class="nav-text">open&#x2F;creat Function</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Parameter%E2%80%8F%E2%80%9Dflags%E2%80%9D"><span class="nav-text">Parameter‏”flags”</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Parameter%E2%80%8F-mode"><span class="nav-text">Parameter‏: mode</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#close-Funtion"><span class="nav-text">close Funtion</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#read-write-Function"><span class="nav-text">read&#x2F;write Function</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BE%8B%E5%AD%90"><span class="nav-text">例子</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#lseek-Function"><span class="nav-text">lseek Function</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dup-dup2-Function"><span class="nav-text">dup&#x2F;dup2 Function</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#fcntl-Function"><span class="nav-text">fcntl Function</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#cmd"><span class="nav-text">cmd</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ioctl-Function"><span class="nav-text">ioctl Function</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#fsync-Function"><span class="nav-text">fsync Function</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E6%94%B9%E5%90%8D"><span class="nav-text">文件改名</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E6%96%87%E4%BB%B6%E5%B1%9E%E6%80%A7"><span class="nav-text">获取文件属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E6%96%87%E4%BB%B6"><span class="nav-text">删除文件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#change-ownership"><span class="nav-text">change ownership</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%AE%E5%BD%95%E6%93%8D%E4%BD%9C"><span class="nav-text">目录操作</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Data-structures"><span class="nav-text">Data structures</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%AE%E5%BD%95%E7%9A%84%E6%89%93%E5%BC%80%E3%80%81%E5%85%B3%E9%97%AD%E3%80%81%E8%AF%BB%E3%80%81%E5%AE%9A%E4%BD%8D"><span class="nav-text">目录的打开、关闭、读、定位</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#example"><span class="nav-text">example</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%B9%B6%E6%8C%82%E8%BD%BD%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="nav-text">创建并挂载文件系统</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Standard-I-O-Library"><span class="nav-text">Standard I&#x2F;O Library</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#File-Stream"><span class="nav-text">File Stream</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Stream-Buffering-Operations"><span class="nav-text">Stream Buffering Operations</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Standard-I-O-Functions"><span class="nav-text">Standard I&#x2F;O Functions</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Stream-open-close"><span class="nav-text">Stream open&#x2F;close</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Open-a-stream"><span class="nav-text">Open a stream:</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Close-a-stream"><span class="nav-text">Close a stream</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#character-operations"><span class="nav-text">character operations</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#input-of-a-character"><span class="nav-text">input of a character</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#output-of-a-character"><span class="nav-text">output of a character</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Line-of-String-operations"><span class="nav-text">Line of String operations</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Input-of-a-Line-of-String"><span class="nav-text">Input of a Line of String</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Output-of-a-Line-of-String"><span class="nav-text">Output of a Line of String</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Binary-Stream-Input-Output"><span class="nav-text">Binary Stream Input&#x2F;Output</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Formatted-I-O"><span class="nav-text">Formatted I&#x2F;O</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Reposition-a-stream"><span class="nav-text">Reposition a stream</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Flush-a-stream"><span class="nav-text">Flush a stream</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Stream-and-File-Descriptor"><span class="nav-text">Stream and File Descriptor</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Temporary-File"><span class="nav-text">Temporary File</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Advanced-System-Calls"><span class="nav-text">Advanced System Calls</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#stat-fstat-lstat-functions"><span class="nav-text">stat&#x2F;fstat&#x2F;lstat functions</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#struct-stat"><span class="nav-text">struct stat</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Test-macros-for-file-types"><span class="nav-text">Test macros for file types</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#File-lock"><span class="nav-text">File lock</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%87%E5%BF%97%E4%BD%8D"><span class="nav-text">标志位</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#fcntl%E8%AE%B0%E5%BD%95%E9%94%81"><span class="nav-text">fcntl记录锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#struct-flock"><span class="nav-text">struct flock</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#cmd%E5%8F%82%E6%95%B0"><span class="nav-text">cmd参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B6%E5%AE%83%E5%B0%81%E9%94%81%E5%91%BD%E4%BB%A4"><span class="nav-text">其它封锁命令</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="LYK-love"
      src="/images/white_flower1.jpg">
  <p class="site-author-name" itemprop="name">LYK-love</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">216</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">23</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">50</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/LYK-love" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;LYK-love" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:191820133@smail.nju.edu.cn" title="E-Mail → mailto:191820133@smail.nju.edu.cn" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://lyk-love.cn/2022/05/05/Linux-Programming/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/white_flower1.jpg">
      <meta itemprop="name" content="LYK-love">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LYK-love">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Linux Programming | LYK-love">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Linux Programming
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-05-05 03:43:30" itemprop="dateCreated datePublished" datetime="2022-05-05T03:43:30Z">2022-05-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-02-08 07:44:07" itemprop="dateModified" datetime="2023-02-08T07:44:07Z">2023-02-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Technology/" itemprop="url" rel="index"><span itemprop="name">Technology</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>Outline：</p>
<ul>
<li>Linux文件操作api</li>
</ul>
<span id="more"></span>
<h1 id="Linux-File"><a class="header-anchor" href="#Linux-File"></a>Linux File</h1>
<h2 id="File-types"><a class="header-anchor" href="#File-types"></a>File types</h2>
<p>从细节来说，文件类型分为:</p>
<ul>
<li>regular file</li>
<li>character special file： 与设备进行交互的文件，按字符IO，如终端文件tty</li>
<li>block special file: 同上，但是按块IO</li>
<li>管道文件/fifo ： 用于进程间通信</li>
<li>socket：表示一个socket连接</li>
<li>symbolic link：符号链接</li>
<li>directory (  目录也是一种文件，我们只是把目录和文件分开讨论 )</li>
</ul>
<h2 id="File-Structure"><a class="header-anchor" href="#File-Structure"></a>File  Structure</h2>
<p>File  Structure:</p>
<ul>
<li>Byte stream;</li>
<li>no particular internal structure</li>
</ul>
<h2 id="FIle-Descripter"><a class="header-anchor" href="#FIle-Descripter"></a>FIle Descripter</h2>
<p>Linux中的文件描述符和文件指针FILE *的区别什么？</p>
<ol>
<li>文件描述符：在Linux系统中打开文件就会获得文件描述符，它是很小的正整数。每个进程在PCB(Process Control Block)中保存着一份文件描述表，文件描述符就是这个文件描述符的索引，每个表项都有一个指向已打开文件的指针。</li>
<li>文件指针：C语言中使用文件指针作为I/O的句柄，文件指针指向进程用户区中的一个被称为FILE结构的数据结构。FILE结果包括一个缓冲区和一个文件描述符。而文件描述符是文件描述符表的一个索引，因此从某种意义上文件指针就是句柄的句柄</li>
</ol>
<h2 id="Basic-I-O-System-Calls"><a class="header-anchor" href="#Basic-I-O-System-Calls"></a>Basic I/O System Calls</h2>
<ul>
<li>File descriptor</li>
<li>Basic I/O:
<ul>
<li>open/creat, close, read, write, lseek</li>
<li>dup/dup2</li>
<li>fcntl</li>
<li>ioctl</li>
</ul>
</li>
</ul>
<h2 id="File-descriptor"><a class="header-anchor" href="#File-descriptor"></a>File descriptor</h2>
<p>File descriptor:</p>
<ul>
<li>A small non-negative integer
<ul>
<li><code>int fd;</code></li>
</ul>
</li>
<li><strong>是thread local的</strong></li>
<li>在UNIX中用于访问文件,  也可以将它作为指向文件对象的指针</li>
<li>in <code>&lt;unistd.h&gt;</code>
<ul>
<li><strong>STDIN_FILENO: 0</strong></li>
<li><strong>STDOUT_FILENO : 1</strong></li>
<li><strong>STDERR_FILENO: 2</strong></li>
</ul>
</li>
<li>进程总是会打开0,1,2这三个文件描述符</li>
</ul>
<p>General steps of file operation:</p>
<ol>
<li>open</li>
<li>read/write</li>
<li>[lseek]</li>
<li>close</li>
</ol>
<h2 id="File-Name-Suffix"><a class="header-anchor" href="#File-Name-Suffix"></a>File Name Suffix</h2>
<table>
<thead>
<tr>
<th>suffix</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>.c</td>
<td>C source code which must be preprocessed</td>
</tr>
<tr>
<td>.i</td>
<td>C source code which should not be preprocessed</td>
</tr>
<tr>
<td>.cc.cp.cpp.CPP. c++ .C .cxx</td>
<td>C++sourcecodewhichmustbepreprocessed</td>
</tr>
<tr>
<td>.ii</td>
<td>C++ source code which should not be preprocessed</td>
</tr>
<tr>
<td>.h</td>
<td>C or C++ header file to be turned into a precompiled header</td>
</tr>
<tr>
<td>.H .hh</td>
<td>C++ header file to be turned into a precompiled header</td>
</tr>
<tr>
<td>.s</td>
<td>Assembler code</td>
</tr>
<tr>
<td>.S</td>
<td>Assembler code which must be preprocessed</td>
</tr>
<tr>
<td>.o</td>
<td>Object file</td>
</tr>
<tr>
<td>.a</td>
<td>Static library file (archive file)</td>
</tr>
<tr>
<td>.so</td>
<td>Dynamic library file (shared object)</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="File-Permission"><a class="header-anchor" href="#File-Permission"></a>File Permission</h2>
<table>
<thead>
<tr>
<th>Perm</th>
<th>File</th>
<th>Directory</th>
</tr>
</thead>
<tbody>
<tr>
<td>r</td>
<td>User can read contents of file</td>
<td>User can list the contents of the directory</td>
</tr>
<tr>
<td>w</td>
<td>User can change contents of file</td>
<td>User can change the contents of the directory</td>
</tr>
<tr>
<td>x</td>
<td>User can execute file as a command</td>
<td>User can cd to directory and can use it in PATH</td>
</tr>
<tr>
<td>SUID</td>
<td><strong>Program runs with effective user ID of owner</strong></td>
<td></td>
</tr>
<tr>
<td>SGID</td>
<td>Program runs with effective group ID of owner</td>
<td>Files created in directory inherit the same group ID as the directory</td>
</tr>
<tr>
<td>Sticky bit</td>
<td></td>
<td>Only the owner of the file and the owner of the directory may delete files in this directory</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th><strong>mode</strong></th>
<th><strong>含义</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>S_IRUSR (00400)</td>
<td>Read by owner</td>
</tr>
<tr>
<td>S_IWUSR (00200)</td>
<td>Write by owner</td>
</tr>
<tr>
<td>S_IXUSR (00100)</td>
<td>Execute by owner</td>
</tr>
<tr>
<td>S_IRWXU(00700)</td>
<td>Read, write and execute by owner</td>
</tr>
<tr>
<td>S_IRGRP (00040)</td>
<td>Read by group</td>
</tr>
<tr>
<td>S_IWGRP (00020)</td>
<td>Write by group</td>
</tr>
<tr>
<td>S_IXGRP (00010)</td>
<td>Execute by group</td>
</tr>
<tr>
<td>S_IRWXG (00070)</td>
<td>Read, write and execute by group</td>
</tr>
<tr>
<td>S_IROTH (00004)</td>
<td>Read by others</td>
</tr>
<tr>
<td>S_IWOTH (00002)</td>
<td>Write by others</td>
</tr>
<tr>
<td>S_IXOTH (00001)</td>
<td>Execute by others</td>
</tr>
<tr>
<td>S_IRWXO (00007)</td>
<td>Read, write and execute by others</td>
</tr>
<tr>
<td>S_ISUID(04000)</td>
<td>Set user ID on execution</td>
</tr>
<tr>
<td>S_ISGID(02000)</td>
<td>Set group ID on execution</td>
</tr>
<tr>
<td>S_ISVTX(01000)</td>
<td>Saved-text bit (sticky bit)</td>
</tr>
</tbody>
</table>
<p>Example: testing file permission:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (buf.st_mode &amp; S_IRUSR)</span><br><span class="line">	<span class="built_in">printf</span>(“readable by owner”);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	<span class="built_in">printf</span>(“unreadable by owner”);</span><br></pre></td></tr></table></figure>
<h3 id="umask"><a class="header-anchor" href="#umask"></a>umask</h3>
<p><code> umask</code>：  文件权限屏蔽字,  是用户在建立文件或目录时需要减掉的权限</p>
<ul>
<li>
<p><strong>file persission = mode &amp; ~umask</strong></p>
</li>
<li>
<p>命令行工具：<code> umask</code></p>
<ul>
<li><code>umask -S</code>:  以符号形式显示</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">❯ umask //表明group和others没有2（写）权限</span><br><span class="line">022</span><br><span class="line"></span><br><span class="line">//或者</span><br><span class="line">❯ umask -S </span><br><span class="line">u=rwx,g=rx,o=rx</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="type">mode_t</span> <span class="title function_">umask</span><span class="params">(<span class="type">mode_t</span> mask)</span>; <span class="comment">//为进程设置文件存取权限屏蔽字，并返回以前的值</span></span><br></pre></td></tr></table></figure>
<p>Regular files:</p>
<table>
<thead>
<tr>
<th>permissions</th>
<th>symbol</th>
<th>number</th>
</tr>
</thead>
<tbody>
<tr>
<td>default permissions</td>
<td><code>rw-rw-rw-</code></td>
<td>666</td>
</tr>
<tr>
<td>umask</td>
<td><code>----w--w-</code></td>
<td>022</td>
</tr>
<tr>
<td>resulting permissions</td>
<td><code>rw-r--r--</code></td>
<td>644</td>
</tr>
</tbody>
</table>
<p>Directories:</p>
<table>
<thead>
<tr>
<th>permissions</th>
<th>symbol</th>
<th>number</th>
</tr>
</thead>
<tbody>
<tr>
<td>default permissions</td>
<td><code>rwxrwxrwx</code></td>
<td>777</td>
</tr>
<tr>
<td>umask</td>
<td><code>----w--w-</code></td>
<td>022</td>
</tr>
<tr>
<td>resulting permissions</td>
<td><code>rwxr-xr-x</code></td>
<td>755</td>
</tr>
</tbody>
</table>
<h3 id="access-function"><a class="header-anchor" href="#access-function"></a>access function</h3>
<p>按实际用户ID和实际组ID测试文件存取权限</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">access</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">int</span> mode)</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>Return: 0 if success; -1 if failure</li>
<li>Parameter‏ <code>mode</code>:
<ul>
<li><code>R_OK</code></li>
<li><code>W_OK</code></li>
<li><code>X_OK</code></li>
<li><code>F_OK</code></li>
</ul>
</li>
</ul>
<h3 id="chmod-fchmod-functions"><a class="header-anchor" href="#chmod-fchmod-functions"></a>chmod/fchmod functions</h3>
<p>Change permissions of a file:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">chmod</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *path, <span class="type">mode_t</span> mode)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">fchmod</span><span class="params">(<span class="type">int</span> fildes, <span class="type">mode_t</span> mode)</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>Return: 0 if success; -1 if failure</li>
</ul>
<h2 id="File-Attribute"><a class="header-anchor" href="#File-Attribute"></a>File Attribute</h2>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">stat</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">dev_t</span> st_dev; <span class="comment">//device 文件的设备编号</span></span><br><span class="line">  <span class="type">ino_t</span> st_ino; <span class="comment">//inode 文件的i-node</span></span><br><span class="line">  <span class="type">mode_t</span> st_mode; <span class="comment">//protection 文件的类型和存取的权限</span></span><br><span class="line">  <span class="type">nlink_t</span> st_nlink; <span class="comment">//number of hard links 连到该文件的硬链接数目, 刚建立的文件值为1.</span></span><br><span class="line">  <span class="type">uid_t</span> st_uid; <span class="comment">//user ID of owner 文件所有者的用户识别码</span></span><br><span class="line">  <span class="type">gid_t</span> st_gid; <span class="comment">//group ID of owner 文件所有者的组识别码</span></span><br><span class="line">  <span class="type">dev_t</span> st_rdev; <span class="comment">//device type 若此文件为装置设备文件, 则为其设备编号</span></span><br><span class="line">  <span class="type">off_t</span> st_size; <span class="comment">//total size, in bytes 文件大小, 以字节计算</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> st_blksize; <span class="comment">//blocksize for filesystem I/O 文件系统的I/O 缓冲区大小.</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> st_blocks; <span class="comment">//number of blocks allocated 占用文件区块的个数, 每一区块大小为512 个字节.</span></span><br><span class="line">  <span class="type">time_t</span> st_atime; <span class="comment">//time of lastaccess 文件最近一次被存取或被执行的时间, 一般只有在用mknod、utime、read、write 与tructate 时改变.</span></span><br><span class="line">  <span class="type">time_t</span> st_mtime; <span class="comment">//time of last modification 文件最后一次被修改的时间, 一般只有在用mknod、utime 和write 时才会改变</span></span><br><span class="line">  <span class="type">time_t</span> st_ctime; <span class="comment">//time of last change i-node 最近一次被更改的时间, 此参数会在文件所有者、组、权限被更改时更新</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>shell中可以用<code>stat</code>工具</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">stat far</span><br><span class="line">  File: far</span><br><span class="line">  Size: 6               Blocks: 8          IO Block: 4096   regular file</span><br><span class="line">Device: 259,8   Inode: 2536724     Links: 1</span><br><span class="line">Access: (0777/-rwxrwxrwx)  Uid: ( 1000/     lyk)   Gid: ( 1001/     lyk)</span><br><span class="line">Access: 2021-11-26 21:31:56.163748288 +0800</span><br><span class="line">Modify: 2021-11-26 21:41:07.306528022 +0800</span><br><span class="line">Change: 2021-11-26 21:59:32.375301046 +0800</span><br><span class="line"> Birth: 2021-11-26 21:31:56.163748288 +0800</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="Linux-Signal"><a class="header-anchor" href="#Linux-Signal"></a>Linux Signal</h1>
<pre><code>  1. SIGHUP连接挂断
  2. SIGINT终端中断
  3. SIGKILL终止进程（此信号不能被捕获或忽略）
  4. SIGQUIT终端退出
  5. SIGTERM终止
  6. SIGCHLD子进程已经停止或退出
  7. SIGCONT继续执行暂停进程
  8. SIGSTOP停止执行（此信号不能被捕获或忽略）
  9. SIGTSTP终端挂起
</code></pre>
<h1 id="I-O系统调用"><a class="header-anchor" href="#I-O系统调用"></a>I/O系统调用</h1>
<h3 id="open-creat-Function"><a class="header-anchor" href="#open-creat-Function"></a>open/creat Function</h3>
<p>Open and possibly create a file or device</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">open</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">int</span> flags)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">open</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">int</span> flags, <span class="type">mode_t</span> mode)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">creat</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">mode_t</span> mode)</span>; <span class="comment">// equivalent to open with flags: O_CREAT|O_WRONLY|O_TRUNC</span></span><br></pre></td></tr></table></figure>
<ul>
<li>Return: a new file descriptor if success; -1 if failure</li>
</ul>
<h4 id="Parameter‏”flags”"><a class="header-anchor" href="#Parameter‏”flags”"></a>Parameter‏”flags”</h4>
<p>“flags”:‏file‏ access‏ mode</p>
<ul>
<li>定义在 <code>&lt;fcntl.h&gt;</code></li>
<li>分为主标志和副标志， 主标志必须，且是互斥的，即只能选择一种。 副标志是可选的，可以选择多个</li>
<li>标志之间用<code>|</code>隔开</li>
</ul>
<table>
<thead>
<tr>
<th>主标志</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>O_RDONLY</strong></td>
<td><strong>以只读方式打开文件</strong></td>
</tr>
<tr>
<td><strong>O_WRONLY</strong></td>
<td><strong>以只写方式打开文件</strong></td>
</tr>
<tr>
<td><strong>O_RDWR</strong></td>
<td><strong>以可读写方式打开文件</strong></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>副标志</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>O_TRUNC</strong></td>
<td>**若文件存在并且以可写的方式打开时，**此标志会将文件长度清为0，而原来存于该文件的资料也会消失</td>
</tr>
<tr>
<td><strong>O_CREAT</strong></td>
<td><strong>若路径中的文件不存在则自动建立该文件</strong></td>
</tr>
<tr>
<td><strong>O_EXCL</strong></td>
<td>如果与O_CREAT同时设置，此指令会去检查文件是否存在，文件若不存在则建立该文件，否则将导致打开文件错误。此外，若O_CREAT与O_EXCL同时设置，并且将要打开的文件为符号链接，则将导致打开文件失败</td>
</tr>
<tr>
<td><strong>O_APPEND</strong></td>
<td>读写文件从文件尾部开始移动，所写入的数据追加到文件尾</td>
</tr>
</tbody>
</table>
<h4 id="Parameter‏-mode"><a class="header-anchor" href="#Parameter‏-mode"></a>Parameter‏: mode</h4>
<p>mode:  设定新建的文件的权限,    详见下文《File Permission》</p>
<h3 id="close-Funtion"><a class="header-anchor" href="#close-Funtion"></a>close Funtion</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Close a file descriptor</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">close</span><span class="params">(<span class="type">int</span> fd)</span>;</span><br><span class="line">(Return: <span class="number">0</span> <span class="keyword">if</span> success; <span class="number">-1</span> <span class="keyword">if</span> failure)</span><br></pre></td></tr></table></figure>
<p><code>open</code>系统调用：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span>    </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span>    </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> fd = <span class="built_in">open</span>(<span class="string">&quot;foo&quot;</span>, O_CREAT, O_WRONLY | O_TRUNC);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p><code>open</code>返回<code>file discriptor</code>,这是一个thread local的整数，在UNIX中用于访问文件。 也可以将它作为指向文件对象的指针</p>
</li>
<li>
<p>打开文件过程：</p>
<ol>
<li>检索目录,把它的外存索引节点复制到活动索引节点表。</li>
<li>根据参数<code>mode</code>核对权限,如果非法,则这次打开失败。</li>
<li>当“打开”合法时,为文件分配用户打开文件表项和系统打开文件表项,并为表项设置初值。通过指针建立这些表项与活动索引节点间的联系。把<code>fd</code>,即用户打开文件表中相应文件表项的序号返回给调用者。</li>
</ol>
</li>
<li>
<p>关闭文件过程：</p>
<ol>
<li>根据<code>fd</code>找到用户打开文件表项,再找到系统打开文件表项。释放用户打开文件表项。</li>
<li>把对应系统打开文件表项中的<code>f_count--</code>如果非“0”,说明还有进程共享这一表项,不用释放直接返回;否则释放表项</li>
<li>把活动索引节点中的<code>i_count --</code>,若不为“0”,表明还有用户进程正在使用该文件,不用释放而直接返回,否则在把该活动索引节点中的内容复制回文件卷上的相应索引节点中后,释放该活动索引节点。</li>
</ol>
</li>
<li>
<p>f_count和i_count分别反映进程动态地共享一个文件的两种方式,</p>
<ul>
<li><code>f_count</code>反映不同进程通过同一个系统打开文件表项共享<br>
一个文件的情况;</li>
<li><code>i_count</code>反映不同进程通过不同系统打开文件表项共享一<br>
个文件的情况。</li>
<li>通过两种方式,进程之间既可用相同的位移指针f_offset,<br>
也可用不同位移指针f_offset共享同一个文件。</li>
</ul>
</li>
</ul>
<h3 id="read-write-Function"><a class="header-anchor" href="#read-write-Function"></a>read/write Function</h3>
<p><code>&lt;unistd.h&gt;</code></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Read from a file descriptor</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">read</span><span class="params">(<span class="type">int</span> fd, <span class="type">void</span> *buf, <span class="type">size_t</span> count)</span>;</span><br><span class="line">(返回值: )</span><br><span class="line"></span><br><span class="line"><span class="comment">//Write to a file descriptor</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">write</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="type">void</span> *buf, <span class="type">size_t</span> count)</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>第一个参数为文件描述符</li>
<li>第二个参数指向放置结果的缓冲区</li>
<li>第三个参数是缓冲区大小</li>
<li>返回值：
<ul>
<li><code>read()</code>: 读到的字节数，若已到文件尾为0. 若出错为-1</li>
<li><code>write()</code>: 若成功为已写的字节数. 若出错为-1</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// myCat.c</span></span><br><span class="line"><span class="keyword">while</span> ((n = read(STDIN_FILENO, buf, BUFSIZE)) &gt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (write(STDOUT_FILENO, buf, n) != n)</span><br><span class="line">		err_sys(“write error”);	</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (n&lt;<span class="number">0</span>)</span><br><span class="line">		err_sys(“read error”);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="例子"><a class="header-anchor" href="#例子"></a>例子</h4>
<p>使用<code>strace</code>跟踪system call</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash"><span class="built_in">echo</span> hello&gt;foo</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">strace <span class="built_in">cat</span> foo</span> </span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">open(<span class="string">&quot;foo&quot;</span>, O_RDonly|O_LARGEFILE) //使用64位偏移量（ O_LARGEFILE ）</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash"><span class="built_in">read</span>(3, <span class="string">&quot;hello\n&quot;</span>, 6  )</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash"><span class="built_in">read</span>(3,<span class="string">&quot;&quot;</span>,4096)</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">close(3)</span></span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">prompt</span></span><br></pre></td></tr></table></figure>
<p>这是书上的输出，我自己manjaro64的打印结果如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line">openat(AT_FDCWD, &quot;foo&quot;, O_RDONLY)       = 3</span><br><span class="line">...</span><br><span class="line">read(3, &quot;hello\n&quot;, 131072)              = 6</span><br><span class="line">write(1, &quot;hello\n&quot;, 6hello)             = 6</span><br><span class="line">read(3, &quot;&quot;, 131072)                     = 0</span><br><span class="line">munmap(0x7f90b3935000, 139264)          = 0</span><br><span class="line">close(3)                                = 0</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>省略了一些输出</p>
<ul>
<li>
<p><code>cat</code>先打开文件准备读取</p>
<ul>
<li>每个进程已经打开了三个文件： <code>std input</code>, <code>std output</code>, <code>std err</code>,其文件描述符分别为<code>0</code>，<code>1</code>，<code>2</code>。 因此<code>open</code>返回<code>3</code></li>
</ul>
</li>
<li>
<p>打开后，<code>cat</code>使用<code>read()</code> system call,</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">ssize_t</span> <span class="title function_">read</span><span class="params">(<span class="type">int</span> fd, <span class="type">void</span> * buf, <span class="type">size_t</span> count)</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>第一个参数为文件描述符</li>
<li>第二个参数指向放置结果的缓冲区, <code>strace</code>显示了此时的读取结果<code>hello\n</code></li>
<li>第三个参数是缓冲区大小, 在我的电脑上是<code>139264B</code></li>
<li>返回值为其读取的字节数，这里是<code>6</code></li>
</ul>
</li>
<li>
<p>同样能看到，<code>write（）</code>针对文件描述符<code>1</code>，这是标准输出。</p>
<ul>
<li>这是<code>cat</code>要做的事，它可能直接调用<code>write（）</code>，也可能调用库例程<code>printf（）</code>，当然最终还是会调用<code>write（）</code></li>
</ul>
</li>
<li>
<p>然后，<code>cat</code>试图从文件中读取更多内容，但是文件中没有剩余字节，<code>read（）</code>返回0</p>
</li>
<li>
<p>程序知道它已经读取完了文件，因此调用<code>close（）</code>，传入相应的文件描述符（<code>3</code>），该文件因此会关闭</p>
</li>
</ul>
<h3 id="lseek-Function"><a class="header-anchor" href="#lseek-Function"></a>lseek Function</h3>
<p>不按顺序读取和写入</p>
<p>Reposition read/write file offset:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">off_t</span> <span class="title function_">lseek</span><span class="params">(<span class="type">int</span> fildes, <span class="type">off_t</span> offset, <span class="type">int</span> whence)</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>Return: the resulting offset location if success; -1 if failure</p>
</li>
<li>
<p>参数 offset 的含义取决于参数 whence：</p>
<ul>
<li>如果 whence 是 SEEK_SET，文件偏移量将被设置为 offset。</li>
<li>如果 whence 是 SEEK_CUR，文件偏移量将被设置为 当前偏移量加上 offset，offset 可以为正也可以为负。</li>
<li>如果 whence 是 SEEK_END，文件偏移量将被设置为文件长度加上 offset，   offset 可以为正也可以为负。</li>
</ul>
</li>
</ul>
<p>使用<code>lseek（）</code></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">off_t</span> <span class="title function_">lseek</span><span class="params">(<span class="type">int</span> fildes, <span class="type">off_t</span> offset, <span class="type">int</span> whence)</span>;</span><br></pre></td></tr></table></figure>
<p>可以看到，对每个进程打开的文件，OS都会跟踪一个当前偏移量<code>offset</code>。 要么每次读写后隐式更新，要么通过<code>lssek（）</code>指定</p>
<h3 id="dup-dup2-Function"><a class="header-anchor" href="#dup-dup2-Function"></a>dup/dup2 Function</h3>
<p>dup用来复制oldfd所指的文件描述符。但复制成功时返回最小的尚未被使用的文件描述符。若有错误则返回－1，错误代码存入errno中。返回的新文件描述符和参数oldfd指向同一个文件，共享所有的锁定，读写指针，和各项权限或标志位</p>
<p>dup2可以用参数newfd指定新文件描述符的数值。若newfd已经被程序使用，系统就会将其关闭以释放该文件描述符；若newfd与oldfd相等，dup2将返回newfd，而不关闭他。dup2调用成功返回新的文件描述符，出错则返回－1</p>
<ul>
<li>
<p>Duplicate a file descriptor</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">dup</span><span class="params">(<span class="type">int</span> oldfd)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">dup2</span><span class="params">(<span class="type">int</span> oldfd, <span class="type">int</span> newfd)</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>Return: the new file descriptor if success; -1 if failure</li>
</ul>
</li>
<li>
<p>File sharing</p>
<ul>
<li><strong>Example: redirection</strong>, 步骤详见<em>Using Shell</em>， dup/dup2所做的就是给原有的文件描述符再分配一个复制，由于此时标准输出/输入一半已经关闭，新分配的fd一般就是标准输出/输入，这就实现了重定向</li>
</ul>
</li>
</ul>
<h3 id="fcntl-Function"><a class="header-anchor" href="#fcntl-Function"></a>fcntl Function</h3>
<p>Manipulate a file descriptor，该函数对fd的操作比较全面</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">fcntl</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> cmd)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">fcntl</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> cmd, <span class="type">long</span> arg)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">fcntl</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> cmd, <span class="keyword">struct</span> flock *lock)</span></span>;<span class="comment">//可以对文件加锁</span></span><br><span class="line"><span class="comment">//(返回值: 若成功则依赖于cmd，若出错为-1)</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>The‏ operation‏ is‏ determined ‏by‏&quot;cmd&quot;.</li>
<li>The‏ value‏ of‏&quot;cmd&quot;
<ol>
<li><strong>F_DUPFD</strong>: Duplicate a file descriptor</li>
<li><strong>F_GETFD/F_SETFD</strong>:‏Get/set ‏the‏ file‏d escriptor's</li>
<li><strong>‏close-on exec</strong> flag：执行时是否关闭，文件描述符能否从父进程传递到子进程。</li>
<li>F_GETFL/F_SETFL:‏Get/set ‏the‏ file ‏descriptor's <strong>‏flags</strong>(并不是所有情况都可以setfl的)</li>
<li>F_GETOWN/F_SETOWN: Manage I/O availability signals(告诉当前进程是否I/O传来的信号)(不要求理解深刻)</li>
<li>F_GETLK/F_SETLK/F_SETLKW: Get/set the file lock(暂时不讲)</li>
</ol>
</li>
<li>Example：dup/dup2 and fcntl</li>
</ol>
<h4 id="cmd"><a class="header-anchor" href="#cmd"></a>cmd</h4>
<ul>
<li>
<p>The ‏value ‏of‏ <code>cmd</code>:</p>
<ul>
<li><code>F_DUPFD</code>: Duplicate a file descriptor</li>
<li><code>F_GETFD</code>/<code>F_SETFD</code>:‏Get/set‏the‏file‏descriptor‟s‏close-onexec flag.</li>
<li><code>F_GETFL</code>/<code>F_SETFL</code>:‏Get/set‏the‏file‏descriptor‟s‏flags</li>
<li><code>F_GETOWN</code>/<code>F_SETOWN</code>: Manage I/O availability signals</li>
<li><code>F_GETLK</code>/<code>F_SETLK</code>/<code>F_SETLKW</code>: Get/set the file lock</li>
</ul>
</li>
<li>
<p>Example:</p>
<ul>
<li>dup/dup2 and fcntl</li>
</ul>
</li>
</ul>
<h3 id="ioctl-Function"><a class="header-anchor" href="#ioctl-Function"></a>ioctl Function</h3>
<p>Control devices</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span>  </span></span><br><span class="line"><span class="type">int</span> <span class="title function_">ioctl</span><span class="params">(<span class="type">int</span> d, <span class="type">int</span> request, ...)</span>;</span><br></pre></td></tr></table></figure>
<h3 id="fsync-Function"><a class="header-anchor" href="#fsync-Function"></a>fsync Function</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">fsync</span><span class="params">(<span class="type">int</span> fildes)</span>;</span><br></pre></td></tr></table></figure>
<p>一般来说， 程序执行<code>write（）</code>系统调用时，文件系统会将写入在内存中缓冲一段时间。 要立即写入，需要<code>fsync（）</code></p>
<ul>
<li>强制写回脏数据</li>
</ul>
<h3 id="文件改名"><a class="header-anchor" href="#文件改名"></a>文件改名</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">rename</span><span class="params">(<span class="type">char</span> * oldname, <span class="type">char</span> * newname)</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>rename（）</code>是原子操作</li>
</ul>
<h3 id="获取文件属性"><a class="header-anchor" href="#获取文件属性"></a>获取文件属性</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">int stat(const char * file_name, struct stat *buf);</span><br></pre></td></tr></table></figure>
<p><code>stat()</code>用来将参数<code>file_name</code> 所指的文件状态, 复制到参数<code>buf </code>所指的结构中</p>
<p><code>stat</code>结构体见上文<em>File Attribute</em></p>
<h3 id="删除文件"><a class="header-anchor" href="#删除文件"></a>删除文件</h3>
<p>shell命令<code>rm</code>使用<code>unlink（）</code>系统调用删除文件：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">unlink</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * pathname)</span>;</span><br></pre></td></tr></table></figure>
<h4 id="change-ownership"><a class="header-anchor" href="#change-ownership"></a>change ownership</h4>
<p>Change ownership of a file</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">chown</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *path, <span class="type">uid_t</span> owner, <span class="type">gid_t</span> group)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">fchown</span><span class="params">(<span class="type">int</span> fd, <span class="type">uid_t</span> owner, <span class="type">gid_t</span> group)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">lchown</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *path, <span class="type">uid_t</span> owner, <span class="type">gid_t</span> group)</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>Return: 0 if success; -1 if failure</li>
</ul>
<h3 id="目录操作"><a class="header-anchor" href="#目录操作"></a>目录操作</h3>
<p>仅仅列举函数名:</p>
<ul>
<li><code>mkdir / rmdir</code></li>
<li><code>chdir/fchdir, getcwd</code></li>
<li>Read a directory：
<ul>
<li><code>opendir/closedir</code></li>
<li><code>readdir </code></li>
<li><code>telldir </code></li>
<li><code>seekdir</code></li>
</ul>
</li>
</ul>
<h4 id="Data-structures"><a class="header-anchor" href="#Data-structures"></a>Data structures</h4>
<ul>
<li>
<p><code>DIR</code>: The data type of directory stream objects</p>
<ul>
<li>
<p><code>&lt;dirent.h&gt;</code>:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> __<span class="title">dirstream</span> <span class="title">DIR</span>;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li>
<p>struct dirent:</p>
<ul>
<li>Directory item</li>
<li>Defined in <code>&lt;dirent.h&gt;</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">ino_t</span> d_ino; <span class="comment">/* inode number */</span></span><br><span class="line"><span class="type">char</span> d_name[NAME_MAX + <span class="number">1</span>]; <span class="comment">/* file name */</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="目录的打开、关闭、读、定位"><a class="header-anchor" href="#目录的打开、关闭、读、定位"></a>目录的打开、关闭、读、定位</h4>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dirent.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">DIR *<span class="title function_">opendir</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *name)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">closedir</span><span class="params">(DIR *dir)</span>;</span><br><span class="line"><span class="keyword">struct</span> dirent *<span class="title function_">readdir</span><span class="params">(DIR *dir)</span>;</span><br><span class="line"><span class="type">off_t</span> <span class="title function_">telldir</span><span class="params">(DIR *dir)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">seekdir</span><span class="params">(DIR *dir, <span class="type">off_t</span> offset)</span>;</span><br></pre></td></tr></table></figure>
<h4 id="example"><a class="header-anchor" href="#example"></a>example</h4>
<p>A directory scanning program</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">DIR *dp;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dirent</span> *<span class="title">entry</span>;</span></span><br><span class="line"><span class="keyword">if</span> ( (dp = opendir(dir)) == <span class="literal">NULL</span> )</span><br><span class="line">err_sys(…);</span><br><span class="line"><span class="keyword">while</span> ( (entry = readdir(dp)) != <span class="literal">NULL</span> ) &#123;</span><br><span class="line">lstat(entry-&gt;d_name, &amp;statbuf);</span><br><span class="line"><span class="keyword">if</span> ( S_ISDIR(statbuf.st_mode) )</span><br><span class="line">…</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">…</span><br><span class="line">&#125;</span><br><span class="line">closedir(dp);</span><br></pre></td></tr></table></figure>
<h3 id="创建并挂载文件系统"><a class="header-anchor" href="#创建并挂载文件系统"></a>创建并挂载文件系统</h3>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">mkfs</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="title">mount</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>
<h1 id="Standard-I-O-Library"><a class="header-anchor" href="#Standard-I-O-Library"></a>Standard I/O Library</h1>
<ul>
<li>
<p>File stream</p>
</li>
<li>
<p>Standard I/O functions</p>
</li>
</ul>
<h2 id="File-Stream"><a class="header-anchor" href="#File-Stream"></a>File Stream</h2>
<ul>
<li>Stream ‏and ‏”FILE” ‏structure:
<ul>
<li><code>FILE* fp; </code></li>
<li>Predefined pointer: stdin, stdout, stderr </li>
</ul>
</li>
<li>Buffered I/O</li>
</ul>
<h3 id="Stream-Buffering-Operations"><a class="header-anchor" href="#Stream-Buffering-Operations"></a>Stream Buffering Operations</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span> <span class="comment">// 如果引入的是标准库，就不是系统调用，系统调用的输入参数一般是文件描述符而不是流指针</span></span></span><br></pre></td></tr></table></figure>
<p>三种缓冲</p>
<ol>
<li>块缓冲（完全缓冲）</li>
<li>行缓冲</li>
<li>无缓冲</li>
</ol>
<p>setbuf用于打开或关闭流缓冲机制，参数buf指向一个长度为BUFSIZ（该常量在<code>&lt;stdio.h&gt;</code>中定义）的缓冲区；如果要关闭缓冲，则将buf设置为NULL即可:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">setbuf</span><span class="params">(FILE *stream, <span class="type">char</span> *buf)</span>;</span><br></pre></td></tr></table></figure>
<p>setvbuf用于精确地设置所需的缓冲类型</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">setvbuf</span><span class="params">(FILE *stream, <span class="type">char</span> *buf, <span class="type">int</span> mode, <span class="type">size_t</span></span></span><br><span class="line"><span class="params">size)</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p><code>mode</code>取值如下：</p>
<ul>
<li><code>_IOFBF</code>: 满缓冲</li>
<li><code>_IOLBF</code>: 行缓冲</li>
<li><code>_IONBF</code>: 无缓冲</li>
</ul>
</li>
<li>
<p>如果指定了mode为带缓冲类型，而buf却为NULL，则系统会自动分配BUFSIZ个字节的缓冲区:</p>
</li>
</ul>
<h2 id="Standard-I-O-Functions"><a class="header-anchor" href="#Standard-I-O-Functions"></a>Standard I/O Functions</h2>
<ul>
<li>Stream open/close</li>
<li>Stream read/write
<ul>
<li>每次一个字符的I/O</li>
<li>每次一行的I/O</li>
<li>直接I/O(二进制I/O)</li>
<li>格式化I/O</li>
</ul>
</li>
<li>Stream reposition</li>
<li>Stream flush</li>
</ul>
<h3 id="Stream-open-close"><a class="header-anchor" href="#Stream-open-close"></a>Stream open/close</h3>
<h4 id="Open-a-stream"><a class="header-anchor" href="#Open-a-stream"></a>Open a stream:</h4>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line">FILE *<span class="title function_">fopen</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *filename, <span class="type">const</span> <span class="type">char</span> *mode)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">fclose</span><span class="params">(FILE *stream)</span>;</span><br></pre></td></tr></table></figure>
<p>Parameter‏ <code>mode</code>:</p>
<ul>
<li><code>r</code>: Open text file for reading.</li>
<li><code>w</code>: Truncate file to zero length or create text file for writing.</li>
<li><code>a</code>: Open for appending.</li>
<li><code>r+</code>: Open for reading and writing.</li>
<li><code>w+</code>: Open for reading and writing. The file is created if it does not exist, otherwise it is truncated.</li>
<li><code>a+</code>: Open for reading and appending. The file is created if does not exist.</li>
</ul>
<h4 id="Close-a-stream"><a class="header-anchor" href="#Close-a-stream"></a>Close a stream</h4>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fclose</span><span class="params">(FILE *fp)</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>Return: 0 if success; -1 if failure</li>
</ul>
<h3 id="character-operations"><a class="header-anchor" href="#character-operations"></a>character operations</h3>
<h4 id="input-of-a-character"><a class="header-anchor" href="#input-of-a-character"></a>input of a character</h4>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">getc</span><span class="params">(FILE *fp)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">fgetc</span><span class="params">(FILE *fp)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">getchar</span><span class="params">(<span class="type">void</span>)</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>Result: Reads the next character from a stream and returns it as an unsigned char cast to an int, or EOF on end of file or error.</li>
</ul>
<p>Three functions:</p>
<ul>
<li><code>ferror</code></li>
<li><code>feof</code></li>
<li><code>clearerr</code></li>
</ul>
<p><code>ungetc</code> function: push a character back to a stream.</p>
<h4 id="output-of-a-character"><a class="header-anchor" href="#output-of-a-character"></a>output of a character</h4>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">putc</span><span class="params">(<span class="type">int</span> c, FILE *fp)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">fputc</span><span class="params">(<span class="type">int</span> c, FILE *fp)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">putchar</span><span class="params">(<span class="type">int</span> c)</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>Return: the character if success; -1 if failure</li>
</ul>
<h3 id="Line-of-String-operations"><a class="header-anchor" href="#Line-of-String-operations"></a>Line of String operations</h3>
<h4 id="Input-of-a-Line-of-String"><a class="header-anchor" href="#Input-of-a-Line-of-String"></a>Input of a Line of String</h4>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">char</span> *<span class="title function_">fgets</span><span class="params">(<span class="type">char</span> *s, <span class="type">int</span> size, FILE *stream)</span>;</span><br><span class="line"><span class="type">char</span> *<span class="title function_">gets</span><span class="params">(<span class="type">char</span> *s)</span>; <span class="comment">//not recommended.</span></span><br></pre></td></tr></table></figure>
<p><code>fgets</code>: reads in at most <strong>size-1</strong> characters from <strong>stream</strong> and stores them into the buffer pointed by <code>s</code>. <strong>Reading stops after an EOF or a new line.</strong>  A <code>\0</code> character is stored at the end of the buffer.</p>
<h4 id="Output-of-a-Line-of-String"><a class="header-anchor" href="#Output-of-a-Line-of-String"></a>Output of a Line of String</h4>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fputs</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *s, FILE *stream)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">puts</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *s)</span>;</span><br></pre></td></tr></table></figure>
<h3 id="Binary-Stream-Input-Output"><a class="header-anchor" href="#Binary-Stream-Input-Output"></a>Binary Stream Input/Output</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">size_t</span> <span class="title function_">fread</span><span class="params">(<span class="type">void</span> *ptr, <span class="type">size_t</span> size, <span class="type">size_t</span> nmemb, FILE *stream)</span>;</span><br><span class="line">size <span class="title function_">fwrite</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *ptr, <span class="type">size_t</span> size, <span class="type">size_t</span> nmemb, FILE *stream)</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>Return: the number of a items successfully read or written</li>
</ul>
<p>Application:</p>
<ul>
<li>
<p>Read/write a binary array:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">float</span> data[<span class="number">10</span>];</span><br><span class="line"><span class="keyword">if</span> ( fwrite(&amp;data[<span class="number">2</span>], <span class="keyword">sizeof</span>(<span class="type">float</span>), <span class="number">4</span>, fp) != <span class="number">4</span> )</span><br><span class="line">err_sys(“fwrite‏error”);</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>Read/write a structure:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line"><span class="type">short</span> count; <span class="type">long</span> total; <span class="type">char</span> name[NAMESIZE];</span><br><span class="line">&#125;item;</span><br><span class="line"><span class="keyword">if</span> ( fwrite(&amp;item, <span class="keyword">sizeof</span>(item), <span class="number">1</span>, fp) != <span class="number">1</span>)</span><br><span class="line">err_sys(“fwrite‏error”);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="Formatted-I-O"><a class="header-anchor" href="#Formatted-I-O"></a>Formatted I/O</h3>
<p>scanf, fscanf, sscanf functions</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">scanf</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *format, ...)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">fscanf</span><span class="params">(FILE *stream, <span class="type">const</span> <span class="type">char</span> *format, ...)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">sscanf</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *str, <span class="type">const</span> <span class="type">char</span> *format, ...)</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>Use fgets, then parse the string</li>
</ul>
<p>printf, fprintf, sprintf functions:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">printf</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *format, ...)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">fprintf</span><span class="params">(FILE *stream, <span class="type">const</span> <span class="type">char</span> *format, ...)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">sprintf</span><span class="params">(<span class="type">char</span> *str, <span class="type">const</span> <span class="type">char</span> *format, ...)</span>;</span><br></pre></td></tr></table></figure>
<h3 id="Reposition-a-stream"><a class="header-anchor" href="#Reposition-a-stream"></a>Reposition a stream</h3>
<p>fseek, ftell, rewind functions:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fseek</span><span class="params">(FILE *stream, <span class="type">long</span> <span class="type">int</span> offset, <span class="type">int</span> whence)</span>;</span><br><span class="line"><span class="type">long</span> <span class="title function_">ftell</span><span class="params">(FILE *stream)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">rewind</span><span class="params">(FILE *stream)</span>;</span><br></pre></td></tr></table></figure>
<p>fgetpos, fsetpos functions ( Introduced in ANSI C):</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fgetpos</span><span class="params">(FILE *fp, <span class="type">fpos_t</span> *pos)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">fsetpos</span><span class="params">(FILE *fp, <span class="type">const</span> <span class="type">fpos_t</span> *pos)</span>;</span><br></pre></td></tr></table></figure>
<h3 id="Flush-a-stream"><a class="header-anchor" href="#Flush-a-stream"></a>Flush a stream</h3>
<p>把流里的数据立刻写入文件</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fflush</span><span class="params">(FILE *stream)</span>;</span><br></pre></td></tr></table></figure>
<h3 id="Stream-and-File-Descriptor"><a class="header-anchor" href="#Stream-and-File-Descriptor"></a>Stream and File Descriptor</h3>
<p>确定流使用的底层文件描述符:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fileno</span><span class="params">(FILE *fp)</span>;</span><br></pre></td></tr></table></figure>
<p>根据已打开的文件描述符创建一个流:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line">FILE *<span class="title function_">fdopen</span><span class="params">(<span class="type">int</span> fildes, <span class="type">const</span> <span class="type">char</span> *mode)</span>;</span><br></pre></td></tr></table></figure>
<h3 id="Temporary-File"><a class="header-anchor" href="#Temporary-File"></a>Temporary File</h3>
<p>Create a name for a temporary file:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">char</span> *<span class="title function_">tmpnam</span><span class="params">(<span class="type">char</span> *s)</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>返回值: 指向唯一路径名的指针</li>
</ul>
<p>Create a temporary file:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line">FILE *<span class="title function_">tmpfile</span><span class="params">(<span class="type">void</span>)</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>返回值: 若成功为文件指针，若出错为NULL</li>
</ul>
<h3 id="Advanced-System-Calls"><a class="header-anchor" href="#Advanced-System-Calls"></a>Advanced System Calls</h3>
<p>Handling file attributes</p>
<ul>
<li>stat/fstat/lstat, ...</li>
</ul>
<p>Handling directory</p>
<h4 id="stat-fstat-lstat-functions"><a class="header-anchor" href="#stat-fstat-lstat-functions"></a>stat/fstat/lstat functions</h4>
<p>Get file status</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">stat</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *filename, <span class="keyword">struct</span> stat *buf)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">fstat</span><span class="params">(<span class="type">int</span> filedes, <span class="keyword">struct</span> stat *buf)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">lstat</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *file_name, <span class="keyword">struct</span> stat *buf)</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>Return: 0 if success; -1 if failure</li>
</ul>
<h4 id="struct-stat"><a class="header-anchor" href="#struct-stat"></a>struct stat</h4>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">stat</span> &#123;</span></span><br><span class="line"><span class="type">mode_t</span> st_mode; <span class="comment">/*file type &amp; mode*/</span></span><br><span class="line"><span class="type">ino_t</span> st_ino; <span class="comment">/*inode number (serial number)*/</span></span><br><span class="line"><span class="type">dev_t</span> st_rdev; <span class="comment">/*device number (file system)*/</span></span><br><span class="line"><span class="type">nlink_t</span> st_nlink; <span class="comment">/*link count*/</span></span><br><span class="line"><span class="type">uid_t</span> st_uid; <span class="comment">/*user ID of owner*/</span></span><br><span class="line"><span class="type">gid_t</span> st_gid; <span class="comment">/*group ID of owner*/</span></span><br><span class="line"><span class="type">off_t</span> st_size; <span class="comment">/*size of file, in bytes*/</span></span><br><span class="line"><span class="type">time_t</span> st_atime; <span class="comment">/*time of last access*/</span></span><br><span class="line"><span class="type">time_t</span> st_mtime; <span class="comment">/*time of last modification*/</span></span><br><span class="line"><span class="type">time_t</span> st_ctime; <span class="comment">/*time of last file status change*/</span></span><br><span class="line"><span class="type">long</span> st_blksize; <span class="comment">/*Optimal block size for I/O*/</span></span><br><span class="line"><span class="type">long</span> st_blocks; <span class="comment">/*number 512-byte blocks allocated*/</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="Test-macros-for-file-types"><a class="header-anchor" href="#Test-macros-for-file-types"></a>Test macros for file types</h4>
<p>Defined in <code>&lt;sys/stat.h&gt;</code></p>
<table>
<thead>
<tr>
<th>Macro</th>
<th>File type</th>
</tr>
</thead>
<tbody>
<tr>
<td>S_ISREG</td>
<td>regular file</td>
</tr>
<tr>
<td>S_ISDIR</td>
<td>directory</td>
</tr>
<tr>
<td>S_ISCHR</td>
<td>character special file</td>
</tr>
<tr>
<td>S_ISBLK</td>
<td>block special file</td>
</tr>
<tr>
<td>S_ISFIFO</td>
<td>fifo</td>
</tr>
<tr>
<td>S_ISLNK()</td>
<td>symbolic link</td>
</tr>
<tr>
<td>S_ISSOCK</td>
<td>socket</td>
</tr>
</tbody>
</table>
<h2 id="File-lock"><a class="header-anchor" href="#File-lock"></a>File lock</h2>
<p>File lock 可以保证文件的并发安全访问</p>
<p>分类：</p>
<ul>
<li>记录锁： 可以锁定文件的部分区域甚至字节</li>
<li>劝告锁
<ul>
<li>检查，加锁由应用程序自己控制</li>
</ul>
</li>
<li>强制锁
<ul>
<li>检查，加锁由内核控制</li>
<li>影响[<code>open()</code>，  <code>read()</code>，  <code>write()</code> 等</li>
</ul>
</li>
<li>共享锁： 读锁，不能加排他锁</li>
<li>排他锁：写锁，不能加读锁或其他写锁</li>
</ul>
<p>特殊类型：</p>
<ul>
<li>共享模式强制锁</li>
<li>租借锁</li>
</ul>
<h3 id="标志位"><a class="header-anchor" href="#标志位"></a>标志位</h3>
<ul>
<li>
<p><code>mount -o mand /dev/sdb7 /mnt </code></p>
</li>
<li>
<p>super_block</p>
<ul>
<li>s_flags</li>
</ul>
</li>
<li>
<p><code>MS_MANDLOCK</code></p>
</li>
</ul>
<h3 id="fcntl记录锁"><a class="header-anchor" href="#fcntl记录锁"></a>fcntl记录锁</h3>
<p>用于记录锁的fcntl函数:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fcntl</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> cmd, <span class="keyword">struct</span> flock *lock)</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>返回值: 若成功则依赖于<code>cmd</code>，若出错为-1</li>
</ul>
<h3 id="struct-flock"><a class="header-anchor" href="#struct-flock"></a>struct flock</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">flock</span>&#123;</span></span><br><span class="line">...</span><br><span class="line"><span class="type">short</span> l_type; <span class="comment">/* Type of lock: F_RDLCK, F_WRLCK, F_UNLCK */</span></span><br><span class="line"><span class="type">short</span> l_whence; <span class="comment">/* How to interpret l_start: SEEK_SET, SEEK_CUR,</span></span><br><span class="line"><span class="comment">SEEK_END */</span></span><br><span class="line"><span class="type">off_t</span> l_start; <span class="comment">/* Starting offset for lock */</span></span><br><span class="line"><span class="type">off_t</span> l_len; <span class="comment">/* Number of bytes to lock */</span></span><br><span class="line"><span class="type">pid_t</span> l_pid; <span class="comment">/* PID of process blocking our lock (F_GETLK only) */</span></span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="cmd参数"><a class="header-anchor" href="#cmd参数"></a>cmd参数</h3>
<p>cmd参数的取值：</p>
<ul>
<li><code>F_GETLK</code>：获得文件的封锁信息</li>
<li><code>F_SETLK</code>：对文件的某个区域封锁或解除封锁</li>
<li><code>F_SETLKW</code>：功能同<code>F_SETLK</code>, wait方式</li>
</ul>
<h3 id="其它封锁命令"><a class="header-anchor" href="#其它封锁命令"></a>其它封锁命令</h3>
<p><code>lockf</code>函数：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/file.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">lockf</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> cmd, <span class="type">off_t</span> len)</span></span><br></pre></td></tr></table></figure>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Linux/" rel="tag"># Linux</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/05/05/make-and-Makefile/" rel="prev" title="make and Makefile">
                  <i class="fa fa-chevron-left"></i> make and Makefile
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/05/05/EulerOS/" rel="next" title="EulerOS">
                  EulerOS <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2021 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">LYK-love</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.8/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>






  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"ams","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>



</body>
</html>
